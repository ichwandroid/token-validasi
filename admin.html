<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Generate Token</title>
  <style>
    body { font-family: sans-serif; padding: 40px; max-width: 400px; margin: auto; }
    input, button { width: 100%; padding: 10px; margin: 10px 0; font-size: 16px; }
    #token, #status, #timer { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Generate Token + Link</h2>
  <input type="text" id="linkInput" placeholder="Masukkan link tujuan" />
  <button id="generateBtn" onclick="generateToken()">Generate</button>
  <button id="checkBtn" onclick="checkTokenStatus()" style="display:none;">Cek Status Token</button>

  <p id="token">Token belum dibuat.</p>
  <p id="status"></p>
  <p id="timer"></p>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyONj36jgb1ZgdPgMLVX3VrwK04P3kvJ25zyp4v3W639UzGaPxpeKtCPRkfZxRz5Ak/exec"; // ganti dengan ID kamu
    let currentToken = null;
    let expireTime = null;
    let timerInterval = null;

    async function generateToken() {
      const link = document.getElementById("linkInput").value;
      if (!link) return alert("Masukkan link terlebih dahulu!");

      const btn = document.getElementById("generateBtn");
      btn.disabled = true;

      const response = await fetch(`${SCRIPT_URL}?action=generate&link=${encodeURIComponent(link)}`);
      const data = await response.json();
      currentToken = data.token;

      document.getElementById("token").innerText = `Token: ${currentToken}`;
      document.getElementById("status").innerText = "✅ Token aktif selama 5 menit";
      document.getElementById("checkBtn").style.display = "block";

      expireTime = new Date().getTime() + 5 * 60 * 1000;
      startCountdown();
    }

    function startCountdown() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const now = new Date().getTime();
        const distance = expireTime - now;
        if (distance <= 0) {
          document.getElementById("timer").innerText = "⏳ Token kadaluwarsa";
          document.getElementById("status").innerText = "❌ Token sudah kadaluwarsa";
          document.getElementById("generateBtn").disabled = false;
          clearInterval(timerInterval);
        } else {
          const m = Math.floor(distance / 60000);
          const s = Math.floor((distance % 60000) / 1000);
          document.getElementById("timer").innerText = `⏳ Token aktif selama: ${m}:${s.toString().padStart(2, '0')}`;
        }
      }, 1000);
    }

    async function checkTokenStatus() {
      if (!currentToken) return alert("Belum ada token.");
      const response = await fetch(`${SCRIPT_URL}?action=check&token=${currentToken}`);
      const data = await response.json();

      if (data.valid) {
        document.getElementById("status").innerText = "✅ Token masih aktif!";
      } else {
        document.getElementById("status").innerText = "❌ Token sudah tidak berlaku!";
      }
    }
  </script>
</body>
</html>
